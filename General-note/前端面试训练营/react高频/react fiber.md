---
title: react fiber
---
# fiber的特点

是一种新的协调引擎
改进协调算法、支持增量渲染、可断点和恢复、支持并发模式、向后兼容、支持错误边界

1.协调算法：根据优先级的协调算法，将任务分解成多个小任务，并根据任务的优先级来调度，从而提高了性能。
2.增量渲染：在处理任务时可断点，优先处理更高优先级的任务，让用户更快的看到页面变化。
3.可断点和恢复：在组件渲染过程中可断点和恢复，从而执行颗粒度更高的控制，提高了应用的吸能和响应速度。
4.并发模式：支持并发模式，在多个线程中执行任务，提高应用性能。
5.向后兼容：在不影响旧版本的情况下逐步升级到新版本，让升级更容易。
6.错误边界：在组件发生错误时，通过错误边界机制来捕获错误并展示错误信息。提高了应用的健壮性和用户体验。

# fiber的流程

包括初始化阶段、任务调度阶段、协调阶段（reconciliation和commit）和完成阶段等。
通过优先级调度器、协调算法、diff算法等来提高应用性能和响应速度。

初始化阶段：通过调用`render()`方法生成虚拟DOM树，并将其存储在Fiber节点中，这个阶段react还会创造一些全局变量，比如workInProgressRoot、nextUnitOfWork等，用于记录当前工作进度和任务单元。

任务调度阶段：通过优先级调度器(priority scheduler)来决定当前要执行的任务单元。每个任务单元都是一个Fiber节点，存储着任务的类型、状态、子节点等信息。Fiber将任务单元按照优先级分为多个批次batch，每个批次包含一组任务单元。Fiber会首先执行高优先级的批次，然后执行低优先级的批次。

协调阶段：在每个任务单元执行之前，会先检查当前任务单元是否需要更新。如果需要更新，会进入协调阶段。根据当前节点和子节点的状态来决定任务单元的执行方式。协调阶段分为reconciliation阶段和commit阶段

reconciliation阶段：Fiber通过遍历Fiber树来比较新旧虚拟DOM的差异，找出需要更新的阶段，并标记为脏节点。通过Diff算法来比较新旧虚拟DOM的差异，尽可能的重用已有节点，减少DOM操作次数。

Commit阶段：在reconciliation阶段结束以后，Fiber进入commit阶段。将所有脏节点更新到真实DOM上。在commit阶段，Fiber会调用各个生命周期方法，比如componentDidMount、ComponentDidUpdate等，完成组件的更新和挂载。

完成阶段：在commit阶段结束后，Fiber将当前工作标记为完成，将结果返回给调用者。如果还有未完成的任务单元，Fiber会继续执行任务调度和协调阶段，直到所有任务完成。