---
title: TCP和UDP
---
[详解 TCP 三次握手、四次挥手，附带精美图解和超高频面试题 - HYN的技术笔记 - SegmentFault 思否](https://segmentfault.com/a/1190000022410446)

重点：
1.TCP和UDP的概念及特点
2.TCP和UDP的区别
3.TCP和UDP的使用场景
4.TCP的三次握手和四次挥手

# TCP和UDP的概念及特点

## UDP
UDP全称用户数据报协议，与TCP一样用于处理数据包，无连接协议。
UDP不能对数据包进行分组、排序和组装，因此报文发送后无法得知是否安全到达。

特点：
1.面向无连接，不需要3次握手建立连接就可以发数据。只是数据报文搬运工，不会拆分或拼接。

在发送端，应用层将数据传输给传输层的UDP协议，UDP只会增加一个UDP头标识一下是UDP协议就传给网络层了。
在接收端，网络层将数据传输给传输层，UDP只会去掉IP报文头就传给应用层了。

2.有单播、多播、广播功能。

3.面向报文，发送方的UDP接收到应用层的报文后，在添加首部就交付IP层。对报文不拆分也不合并，保留边界。

4.不可靠性。无连接，不可靠。收到什么数据就传递什么数据，不会备份，也不关心是否已经收到正确的数据。
网络环境时好时坏，UDP没有拥塞控制，一直以恒定速度发送数据，即使网络不好，也不会对速率进行调整。在网络不好的时候可能造成丢包。
优点也很明显，适用于实时性高的场景，比如电话会议、直播、视频会议。

5.头部开销小，传输数据报文时很高效。
头部包含信息：
1.   2个16位的端口号，分别为源端口和目标端口
2.   整个数据报文的长度
3.   整个数据报文校验和（ipv4可选字段）

因此UDP头部开销小，只有8字节，比TCP的20字节少得多


## TCP
传输控制协议
面向连接、可靠的、基于字节流的传输层通信协议。
TCP是面向连接的、可靠的流协议（流就是不间断的数据结构）

1.面向连接
发送数据之前必须进行双端连接。三次握手

2.单播
每条TCP传输只有两个端点，只能点对点传输

3.面向字节流
不像UDP一个报文一个报文的传输，是在不保留报文边界的情况下以字节流的形式传输

4.可靠的
判断丢包和误码靠TCP的段编号及确认号。
给每一个包一个序号，按序接收。接收端实体对成功收到的字节回一个确认ACK。如果发送端实体在合理的往返时延RTT内没有收到确认，那么对应的数据会被重传。

5.拥塞控制
网络出现拥塞的时候，TCP会减少向网络注入数据的速率和数量

6.全双工通信
TCP允许通信双方在任何时候都能发送数据，因为都设有缓存，临时存放双向通信的数据。

TCP报文头部最小20字节，最大60字节，适用于可靠传输，比如文件传输

# TCP和UDP使用场景

## TCP
效率要求低，准确性要求高的场景。因为传输中需要对数据确认、重发、排序等。
文件传输、接收邮件、远程登录

## UDP
效率要求高、准确度相对低的场景
在线视频、网络语音电话（即时通讯，速度要求高，但偶尔断续问题不大，可以不用重发机制）、广播通信

# TCP的三次握手和四次挥手

建立一个TCP连接的时候客户端和服务器一共发3个包
确定双方发送和接受功能正常，指定自己的初始化序列号。
本质上是连接服务器的指定端口，建立TCP连接，同步双方序列号和确认号，交换TCP窗口大小信息。

## 三次握手

一次握手。客户端发送SYN报文，指明客户端初始化序列号ISN，客户端处于SYN_SENT状态。SYN=1, seq = x
二次握手。服务器收到SYN报文后，以自己的SYN报文作为应答，指定自己的初始化序列号ISN。 SYN = 1, ACK = 1, seq = y, ack = x+1。服务器处于SYN_REVD状态。
三次握手。客户端收到SYN报文后，发送一个ACK报文，表示收到了服务器的报文，客户端处于ESTABLISHED状态。服务器收到ACK报文后，也处于ESTABLISHED状态，此时建立了连接。ACK = 1, seq = x+1, ack = y+1

## 四次挥手

一次挥手。客户端发送FIN报文，指定序列号，客户端处于FIN_WAIT1状态。FIN=1, seq = x
二次挥手。服务器发送ACK报文，处于CLOSE_WAIT状态。ACK=1, seq = y, ack = x+1。这个时候客户端处于FIN_WAIT_2状态。
三次挥手。服务器发送FIN报文，指定序列号，服务器处于LAST-ACK状态。FIN=1, seq = z, ack = x+1。
四次挥手。客户端发送ACK报文，处于TIME-WAIT状态。ACK = 1, seq = x+1, ack = z+1。客户端等待2MSL以后关闭。服务器接收到ACK报文后关闭。

四次挥手是因为客户端发出FIN报文后，可能服务器还有需要发送的数据，只能回复客户端ACK报文表示收到了FIN报文。
发送完数据后再进行两次挥手。

MSL Maximum Segment Lifetime 是报文在网络中最大生存期。TIME-WAIT阶段持续2MSL是为了确保没有服务端重发请求。

按照常理，在网络正常的情况下，四个报文段发送完后，双方就可以关闭连接进入 CLOSED 状态了，但是网络并不总是可靠的，如果客户端发送的 ACK 报文段丢失，服务器在接收不到 ACK 的情况下会一直重发 FIN 报文段，这显然不是我们想要的。因此客户端为了确保服务器收到了 ACK，会设置一个定时器，并在 TIME-WAIT 状态等待 2MSL 的时间，如果在此期间又收到了来自服务器的 FIN 报文段，那么客户端会重新设置计时器并再次等待 2MSL 的时间，如果在这段时间内没有收到来自服务器的 FIN 报文，那就说明服务器已经成功收到了 ACK 报文，此时客户端就可以进入 CLOSED 状态了。